jQuery(document).ready(function($) {
   $(document).on('click', '.aiccgen-redraft-trigger', function(e) {
        e.preventDefault();

        if (!confirm(aiccgen_redraft_vars.confirm_redraft)) {
            return false;
        }

        var $link = $(this);
        var postId = $link.data('postid');
        var nonce = $link.data('nonce'); // The nonce generated by PHP

        // Show a simple loading indicator
        $link.text(aiccgen_redraft_vars.redrafting_message).css('pointer-events', 'none');
        var $originalText = 'Redraft with AI'; // Store original for reset on error

        $.ajax({
            url: aiccgen_redraft_vars.ajax_url,
            type: 'POST',
            data: {
                action: aiccgen_redraft_vars.redraft_action,
                original_post_id: postId,
                _ajax_nonce: nonce // Pass the nonce specific to this action and post
            },
            success: function(response) {
                if (response.success) {
                    // Redirect to the new AI Suggestion edit page
                    if (response.data.redirect_url) {
                        window.location.href = response.data.redirect_url;
                    } else {
                        // Fallback: Reload the current page if no redirect URL (shouldn't happen)
                        alert(response.data.message || 'Redrafted successfully! Reloading...');
                        location.reload();
                    }
                } else {
                    alert(aiccgen_redraft_vars.error_message + (response.data.message ? '\n' + response.data.message : ''));
                    $link.text($originalText).css('pointer-events', 'auto');
                }
            },
            error: function(jqXHR, textStatus, errorThrown) {
                alert(aiccgen_redraft_vars.error_message + '\nDetails: ' + textStatus + ' - ' + errorThrown);
                console.error("Redraft AJAX error:", jqXHR.responseText);
                $link.text($originalText).css('pointer-events', 'auto');
            }
        });
    }); 
});